{% extends "base.html" %}

{% block title %}Reporte de Tránsito{% endblock %}

{% block navbar_brand_text %}Reporte Tránsito{% endblock %}

{% block main_style %}
    background-image: url('{{ url_for('static', filename='logo.jpeg') }}');
    background-repeat: repeat;
    background-size: 120px auto;
    background-color: #e9ecef;
{% endblock %}

{% block content %}
<div class="container-fluid">

    <div class="page-section-header shadow-sm">
        <h1 class="mb-0 h2 page-title-text">
            <i class="bi bi-graph-up page-title-icon"></i> Reporte Consolidado de Tránsito (NSV)
        </h1>
    </div>

    {% if fecha_actualizacion_info %}
    <p class="text-muted small mb-3" style="text-align: center;"> {# Centrado como en la imagen de planta #}
        <i class="bi bi-info-circle-fill me-1"></i> {{ fecha_actualizacion_info }}
    </p>
{% endif %}
    
    <div class="view-toggle-buttons d-flex justify-content-center gap-2 my-4">
      <button id="showRefineriaBtn" class="btn btn-primary btn-lg active">En Camino a Refinería</button>
      <button id="showEdsBtn" class="btn btn-primary btn-lg">En Camino a EDS</button>
    </div>

    <div id="alert-container-reporte" style="position: fixed; top: calc(4.5rem + 20px); right: 20px; z-index: 1050; width: auto; max-width: 400px;"></div>

    {# Contenedor para Refinería #}
    <div id="refineriaContentVisual">
        <h2 class="text-center report-subtitle">Desglose: En Camino a Refinería</h2>
        <div id="camionesRefineriaContainer" class="origenes-container my-3">
            {# Los orígenes y sus productos se renderizarán aquí #}
        </div>
        <div class="total-general-container text-center my-4">
            <h3 class="h4" id="refineriaGrandTotalVisual"></h3>
        </div>
    </div>

    {# Contenedor para EDS #}
    <div id="edsContentVisual" style="display: none;">
        <h2 class="text-center report-subtitle">Desglose: En Camino a EDS</h2>
        <div id="camionesEdsContainer" class="origenes-container my-3">
            {# Los orígenes y sus productos se renderizarán aquí #}
        </div>
        <div class="total-general-container text-center my-4">
            <h3 class="h4" id="edsGrandTotalVisual"></h3>
        </div>
    </div>

</div>

<style>
    .page-section-header {
        background-color: rgba(255, 255, 255, 0.97); padding: 1.25rem 1.5rem;
        border-radius: 0.375rem; margin-bottom: 1.5rem; text-align: center;
    }
    .page-title-text { color: #343a40; font-weight: 600; }
    .page-title-icon { color: #0b8552; font-size: 1.1em; margin-right: 0.5rem; }

    .report-subtitle { color: #0b8552; font-weight: 500; margin-top: 1.5rem; margin-bottom: 1rem; }
    
    .view-toggle-buttons .btn.active { background-color: #0b8552; border-color: #0a7347; color: white; }
    .view-toggle-buttons .btn:not(.active) { background-color: #6c757d; border-color: #5a6268; color: white; }

    .origen-section { /* NUEVO: Contenedor para cada Origen */
        margin-bottom: 2rem;
        padding: 1rem;
        background-color: rgba(255,255,255,0.7);
        border-radius: 0.375rem;
        border: 1px solid #dee2e6;
    }
    .origen-title { /* NUEVO: Título para cada Origen */
        color: #003770; /* Un azul más oscuro para el origen */
        font-size: 1.4rem;
        font-weight: 500;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid #003770;
    }
    .camiones-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); /* Ajustado un poco */
        gap: 15px; /* Reducido un poco el gap entre productos */
    }
    .camion-card {
        background-color: #ffffff; /* Fondo blanco sólido para tarjetas */
        border-radius: 8px; padding: 15px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.07);
        text-align: center;
    }
    .camion-card h5 { color: #0b8552; margin-bottom: 10px; font-size: 1.15rem; }
    .camiones-representacion {
        display: flex; flex-wrap: wrap; justify-content: center;
        gap: 6px; margin-bottom: 10px; min-height: 35px;
    }
    .camion-icono { font-size: 1.8rem; color: #546E7A; margin: 1px; }
    .camion-card .info-item { font-size: 0.9rem; color: #333; margin-bottom: 4px; }
    .camion-card .info-item strong { font-weight: 600; }
    .total-general-container h3 {
        background-color: rgba(11, 133, 82, 0.9); color: white;
        padding: 10px 20px; border-radius: 8px; display: inline-block;
    }
</style>

<script>
    const datosConsolidados = {{ datos_consolidados | default({}) | tojson | safe }};
    const datosConteoCamiones = {{ datos_conteo_camiones | default({}) | tojson | safe }};

    const refineriaContentEl = document.getElementById('refineriaContentVisual');
    const edsContentEl = document.getElementById('edsContentVisual');
    const showRefineriaBtnEl = document.getElementById('showRefineriaBtn');
    const showEdsBtnEl = document.getElementById('showEdsBtn');
    
    const camionesRefineriaContainerEl = document.getElementById('camionesRefineriaContainer');
    const refineriaGrandTotalVisualEl = document.getElementById('refineriaGrandTotalVisual');
    const camionesEdsContainerEl = document.getElementById('camionesEdsContainer');
    const edsGrandTotalVisualEl = document.getElementById('edsGrandTotalVisual');

    function renderizarVisualizacion(tipoDestino) {
        const mainContainer = tipoDestino === 'Refinería' ? camionesRefineriaContainerEl : camionesEdsContainerEl;
        const totalDisplayEl = tipoDestino === 'Refinería' ? refineriaGrandTotalVisualEl : edsGrandTotalVisualEl;
        // Ahora origenesData es un objeto de Origenes, donde cada origen tiene un objeto de Productos
        const origenesData = datosConsolidados[tipoDestino] || {}; 
        
        mainContainer.innerHTML = ''; 
        let grandTotalNSVTipoDestino = 0;

        const nombresOrigenes = Object.keys(origenesData).sort();

        if (nombresOrigenes.length === 0) {
            mainContainer.innerHTML = `<p class="text-center text-muted w-100">No hay datos de tránsito para ${tipoDestino.toLowerCase()}.</p>`;
            totalDisplayEl.textContent = `Total General ${tipoDestino}: 0.00 NSV`;
            return;
        }

        nombresOrigenes.forEach(origen => {
            const productosDataParaOrigen = origenesData[origen];
            const camionesDataParaOrigen = datosConteoCamiones[tipoDestino]?.[origen] || {};
            
            // Crear una sección para este origen
            const origenSectionDiv = document.createElement('div');
            origenSectionDiv.className = 'origen-section';
            
            const origenTitleH3 = document.createElement('h3');
            origenTitleH3.className = 'origen-title';
            origenTitleH3.textContent = `Origen: ${origen}`;
            origenSectionDiv.appendChild(origenTitleH3);

            const productosGridDiv = document.createElement('div');
            productosGridDiv.className = 'camiones-grid'; // Usamos la misma clase para el layout de productos

            const productosOrdenados = Object.keys(productosDataParaOrigen).sort();

            if (productosOrdenados.length === 0) {
                 productosGridDiv.innerHTML = `<p class="text-center text-muted w-100 small">No hay productos para este origen.</p>`;
            }

            productosOrdenados.forEach(producto => {
                const nsvTotalProducto = productosDataParaOrigen[producto];
                const numCamiones = camionesDataParaOrigen[producto] || 0;
                grandTotalNSVTipoDestino += nsvTotalProducto;

                const card = document.createElement('div');
                card.className = 'camion-card';
                
                let camionesHtml = '';
                const maxIconosAMostrar = 8; 
                const numIconos = Math.min(numCamiones, maxIconosAMostrar);
                for (let i = 0; i < numIconos; i++) {
                    camionesHtml += '<i class="bi bi-truck camion-icono"></i>';
                }
                if (numCamiones > maxIconosAMostrar) {
                    camionesHtml += `<span class="ms-1 fs-6 fw-bold text-muted">(+${numCamiones - maxIconosAMostrar})</span>`;
                }

                card.innerHTML = `
                    <h5>${producto}</h5>
                    <div class="camiones-representacion">
                        ${camionesHtml || '<span class="text-muted small">Sin camiones</span>'}
                    </div>
                    <div class="info-item"><strong>${numCamiones}</strong> Camion(es)</div>
                    <div class="info-item"><strong>${nsvTotalProducto.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong> NSV</div>
                `;
                productosGridDiv.appendChild(card);
            });
            origenSectionDiv.appendChild(productosGridDiv);
            mainContainer.appendChild(origenSectionDiv);
        });
        totalDisplayEl.textContent = `Total General ${tipoDestino}: ${grandTotalNSVTipoDestino.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} NSV`;
    }

    showRefineriaBtnEl.addEventListener('click', () => {
        refineriaContentEl.style.display = 'block';
        edsContentEl.style.display = 'none';
        showRefineriaBtnEl.classList.add('active');
        showEdsBtnEl.classList.remove('active');
        renderizarVisualizacion('Refinería');
    });

    showEdsBtnEl.addEventListener('click', () => {
        refineriaContentEl.style.display = 'none';
        edsContentEl.style.display = 'block';
        showEdsBtnEl.classList.add('active');
        showRefineriaBtnEl.classList.remove('active');
        renderizarVisualizacion('EDSM');
    });

    document.addEventListener('DOMContentLoaded', () => {
        showRefineriaBtnEl.click(); 
    });
</script>
{% endblock %}