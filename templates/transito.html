{% extends "base.html" %}

{% block title %}Planilla Tránsito{% endblock %}

{% block navbar_brand_text %}Planilla Tránsito{% endblock %}

{% block main_style %}
    /* Estilo para el fondo del área principal (<main>) */
    background-image: url('{{ url_for('static', filename='logo.jpeg') }}');
    background-repeat: repeat;
    background-size: 120px auto;
    background-color: #e9ecef;
{% endblock %}

{% block content %}
<div class="container-fluid">

    <div class="page-section-header shadow-sm">
        <h1 class="mb-0 h2 page-title-text">
            <i class="bi bi-truck-front-fill page-title-icon"></i> Planilla <span id="tipoTransitoVisual">{{ 'Tránsito Crudo EDSM' if tipo_inicial == 'general' else 'Tránsito Crudo Refinería' }}</span>
        </h1>
    </div>

    <div class="action-buttons-bar text-center my-3">
        <div class="btn-group me-2 mb-2 mb-md-0" role="group">
            <button id="btnGuardarTransito" onclick="guardarRegistro()" class="btn btn-success btn-lg px-4">
                <i class="bi bi-save2-fill"></i> Guardar Registro
            </button>
        </div>
        <div class="btn-group me-2 mb-2 mb-md-0" role="group">
            <a href="{{ url_for('reporte_transito') }}" class="btn btn-info btn-lg text-white px-4">
                <i class="bi bi-file-earmark-bar-graph-fill"></i> Ver Reporte
            </a>
        </div>
        <div class="btn-group me-2 mb-2 mb-md-0" role="group">
             <button id="btnCambiarVistaTransito" onclick="cambiarVista()" class="btn btn-secondary btn-lg px-4">
                <i class="bi bi-arrow-repeat"></i> Cambiar a <span id="toggleNombreVista">{{ 'Tránsito Crudo Refinería' if tipo_inicial == 'general' else 'Tránsito Crudo EDSM' }}</span>
            </button>
        </div>
        <div class="btn-group mb-2 mb-md-0" role="group">
            <button id="btnAnadirFilaTransito" onclick="agregarFilaTransito()" class="btn btn-outline-secondary btn-lg px-4">
                <i class="bi bi-plus-square-dotted"></i> Añadir Fila
            </button>
        </div>
    </div>
    {# El div para el aviso de hora límite se insertará aquí por JS si es necesario #}

    <div id="alert-container" style="position: fixed; top: calc(4.5rem + 20px); right: 20px; z-index: 1050; width: auto; max-width: 400px;"></div>

    <div class="table-container shadow-sm">
        <div class="table-responsive">
            <table class="table table-bordered table-striped table-hover table-sm align-middle">
                <thead class="sticky-top table-header-custom">
                    <tr>
                        <th style="min-width: 170px;">FECHA CARGUE</th>
                        <th style="min-width: 130px;">GUÍA</th>
                        <th style="min-width: 180px;">ORIGEN</th> {# NUEVA COLUMNA #}
                        <th style="min-width: 220px;">PRODUCTO</th>
                        <th style="min-width: 130px;">PLACA</th>
                        <th style="min-width: 120px;">API @ 60°F</th>
                        <th style="min-width: 100px;">%BSW</th>
                        <th style="min-width: 120px;">TOV</th>
                        <th style="min-width: 120px;">GSV</th>
                        <th style="min-width: 120px;">NSV</th>
                        <th style="min-width: 50px;"></th> {# Columna para botón de eliminar fila #}
                    </tr>
                </thead>
                <tbody id="tablaTransitoBody">
                    {# Las filas se generan por JavaScript #}
                </tbody>
            </table>
        </div>
    </div>
</div>

<style>
    .page-section-header {
        background-color: rgba(255, 255, 255, 0.97); padding: 1rem 1.5rem;
        border-radius: 0.375rem; margin-bottom: 0; text-align: center;
    }
    .page-title-text { color: #343a40; font-weight: 600; }
    .page-title-icon { color: #0b8552; font-size: 1.1em; margin-right: 0.5rem; }

    .action-buttons-bar { padding-top: 1rem; padding-bottom: 1rem; }
    .action-buttons-bar .btn-lg { padding-left: 1.2rem; padding-right: 1.2rem; font-size: 0.90rem; }

    .table-container {
        background-color: rgba(255, 255, 255, 0.95); padding: 1.5rem;
        border-radius: 0.375rem; margin-top: 1.5rem;
    }
    .table-header-custom { background-color: #0b8552 !important; color: white !important; }
    .table-responsive thead.sticky-top th { position: sticky; top: 0; z-index: 10;}

    td.cell-input-wrapper { padding: 0.1rem !important; vertical-align: middle; }
    #tablaTransitoBody select.form-select,
    #tablaTransitoBody input.form-control,
    #tablaTransitoBody input.editable-input[type="date"] {
        font-size: 0.875rem; 
        padding: 0.25rem 0.5rem; 
        background-color: #fef9e7;
        border: 1px solid #ced4da;
        border-radius: .2rem;
        width: 100%;
        box-sizing: border-box;
        height: calc(1.5em + .5rem + 2px); 
    }
    #tablaTransitoBody select.form-select:disabled,
    #tablaTransitoBody input.form-control:disabled,
    #tablaTransitoBody input.editable-input[type="date"]:disabled,
    #tablaTransitoBody input.form-control[readonly] {
        background-color: #e9ecef !important;
        color: #6c757d;
        cursor: default !important;
        border-color: #ced4da;
    }
     /* Estilo para el aviso de hora límite */
    .aviso-hora-limite {
        font-size: 0.9rem; padding: 0.75rem 1.25rem; margin-bottom: 1rem;
        border: 1px solid transparent; border-radius: 0.25rem;
    }
    #tablaTransitoBody input.form-control:focus,
    #tablaTransitoBody input.editable-input[type="date"]:focus,
    #tablaTransitoBody select.form-select:focus {
        background-color: #fffde7;
        border-color: #0b8552;
        box-shadow: 0 0 0 0.2rem rgba(11, 133, 82, 0.25);
    }
</style>

<script>
    // --- INICIO: Configuración y Variables Globales ---
    const datosGeneralInit = {{ datos_general | default([]) | tojson | safe }};
    const datosRefineriaInit = {{ datos_refineria | default([]) | tojson | safe }};
    const transitoConfig = {{ transito_config | default({}) | tojson | safe }}; 
    
    let vistaActual = '{{ tipo_inicial | default("general") }}'; 
    let currentData = []; 
    let edicionTransitoPermitida = true; 
    const HORA_LIMITE_REGISTRO_TRANSITO = 10; 

    const tipoTransitoVisualSpan = document.getElementById("tipoTransitoVisual");
    const toggleNombreVistaSpan = document.getElementById("toggleNombreVista");
    const tablaTransitoBody = document.getElementById("tablaTransitoBody");
    const btnGuardarTransito = document.getElementById('btnGuardarTransito');
    const btnAnadirFilaTransito = document.getElementById('btnAnadirFilaTransito');
    // const btnCambiarVistaTransito = document.getElementById('btnCambiarVistaTransito'); // Ya definido arriba
    // --- FIN: Configuración y Variables Globales ---

    function clonarDatosIniciales(datosOriginales) {
        const MIN_FILAS = 10;
        let datosClonados = JSON.parse(JSON.stringify(datosOriginales)).map(fila => ({ ORIGEN: "", PRODUCTO: "", ...fila }));
        while (datosClonados.length < MIN_FILAS) {
            datosClonados.push({"ORIGEN": "", "FECHA": "", "GUIA": "", "PRODUCTO": "", "PLACA": "", "API": "", "BSW": "", "TOV": "", "GSV": "", "NSV": ""});
        }
        return datosClonados;
    }

    function renderTabla() {
        currentData = vistaActual === "general" ? clonarDatosIniciales(datosGeneralInit) : clonarDatosIniciales(datosRefineriaInit);
        tablaTransitoBody.innerHTML = "";

        currentData.forEach((fila, index) => {
            const tr = document.createElement("tr");
            tr.dataset.index = index;

            crearTdFecha(tr, fila, "FECHA");
            crearTdInputAlfanumerico(tr, fila, "GUIA");
            crearTdOrigen(tr, fila, "ORIGEN"); // NUEVO
            crearTdProducto(tr, fila, "PRODUCTO"); // MODIFICADO
            crearTdInputAlfanumerico(tr, fila, "PLACA");
            
            ['API', 'BSW', 'TOV', 'GSV', 'NSV'].forEach(campoKey => {
                crearTdInputNumerico(tr, fila, campoKey);
            });
            crearTdBotonEliminar(tr, index);
            tablaTransitoBody.appendChild(tr);
        });
    }

    function crearTdGenerico(tr) {
        const td = document.createElement("td");
        td.classList.add("cell-input-wrapper");
        tr.appendChild(td);
        return td;
    }
    
    function crearTdFecha(tr, fila, campoKey) {
        const td = crearTdGenerico(tr);
        const input = document.createElement("input");
        input.type = "date";
        input.className = "form-control form-control-sm editable-input"; 
        input.value = fila[campoKey] || "";
        input.dataset.field = campoKey;
        input.disabled = !edicionTransitoPermitida;
        input.addEventListener("change", actualizarDatoFila);
        td.appendChild(input);
    }

    function crearTdInputAlfanumerico(tr, fila, campoKey) {
        const td = crearTdGenerico(tr);
        const input = document.createElement("input");
        input.type = "text";
        input.className = "form-control form-control-sm";
        input.value = fila[campoKey] || "";
        input.dataset.field = campoKey;
        input.disabled = !edicionTransitoPermitida;
        input.addEventListener("change", actualizarDatoFila);
        td.appendChild(input);
    }

    function crearTdInputNumerico(tr, fila, campoKey) {
        const td = crearTdGenerico(tr);
        const input = document.createElement("input");
        input.type = "text";
        input.className = "form-control form-control-sm";
        input.setAttribute('inputmode', 'decimal');
        input.value = String(fila[campoKey] || "").replace('.', ',');
        input.dataset.field = campoKey;
        input.disabled = !edicionTransitoPermitida;
        input.addEventListener("change", actualizarDatoFila);
        input.addEventListener('keydown', function(event) {
            if (!edicionTransitoPermitida) { event.preventDefault(); return; }
            const allowedKeys = ["Backspace", "Delete", "Tab", "Escape", "Enter", "ArrowLeft", "ArrowRight", ".", ","];
            if (allowedKeys.includes(event.key)) {
                if ((event.key === '.' || event.key === ',') && (input.value.includes(',') || input.value.includes('.'))) {
                    event.preventDefault();
                } return;
            }
            if ((event.ctrlKey || event.metaKey) && ['a', 'c', 'v', 'x', 'z'].includes(event.key.toLowerCase())) { return; }
            if (!(event.key >= '0' && event.key <= '9')) { event.preventDefault(); }
        });
        td.appendChild(input);
    }

    function crearTdOrigen(tr, fila, campoKey) {
        const td = crearTdGenerico(tr);
        const select = document.createElement("select");
        select.className = "form-select form-select-sm";
        select.dataset.field = campoKey; // Será "ORIGEN"
        select.disabled = !edicionTransitoPermitida;

        const tipoConfigKey = vistaActual === "general" ? "EDSM" : "REFINERIA";
        const camposParaTipo = transitoConfig[tipoConfigKey]?.campos || {};

        select.innerHTML = '<option value="">Seleccione Origen...</option>';
        for (const nombreOrigen in camposParaTipo) {
            const option = document.createElement("option");
            option.value = nombreOrigen;
            option.textContent = nombreOrigen;
            select.appendChild(option);
        }
        select.value = fila[campoKey] || "";

        select.addEventListener("change", function(event) {
            const rowIndex = parseInt(event.target.closest("tr").dataset.index, 10);
            const nuevoOrigen = event.target.value;
            currentData[rowIndex][campoKey] = nuevoOrigen; // Actualizar ORIGEN en currentData

            const productoSelect = event.target.closest("tr").querySelector('select[data-field="PRODUCTO"]');
            if (productoSelect) {
                const origenConfig = camposParaTipo[nuevoOrigen];
                const productos = origenConfig?.productos || [];
                const autoProducto = origenConfig?.auto_select_product || "";
                
                productoSelect.innerHTML = '<option value="">Seleccione Producto...</option>';
                productos.forEach(prod => {
                    const opt = document.createElement("option");
                    opt.value = prod;
                    opt.textContent = prod;
                    productoSelect.appendChild(opt);
                });
                productoSelect.value = autoProducto;
                currentData[rowIndex]["PRODUCTO"] = autoProducto; // Actualizar PRODUCTO en currentData
            }
        });
        td.appendChild(select);
    }
    
    function crearTdProducto(tr, fila, campoKey) {
        const td = crearTdGenerico(tr);
        const select = document.createElement("select");
        select.className = "form-select form-select-sm";
        select.dataset.field = campoKey; // Será "PRODUCTO"
        select.disabled = !edicionTransitoPermitida;
        
        select.innerHTML = '<option value="">Seleccione Origen primero...</option>';
        
        // Si ya hay un ORIGEN seleccionado en la fila, poblar productos
        const origenActual = fila["ORIGEN"];
        if (origenActual) {
            const tipoConfigKey = vistaActual === "general" ? "EDSM" : "REFINERIA";
            const origenConfig = transitoConfig[tipoConfigKey]?.campos[origenActual];
            if (origenConfig && origenConfig.productos) {
                productoSelect.innerHTML = '<option value="">Seleccione Producto...</option>'; // Limpiar placeholder
                origenConfig.productos.forEach(prod => {
                    const option = document.createElement("option");
                    option.value = prod;
                    option.textContent = prod;
                    select.appendChild(option);
                });
                // Establecer valor y auto-seleccionar si es aplicable
                select.value = fila[campoKey] || origenConfig.auto_select_product || "";
            }
        } else {
             select.value = fila[campoKey] || ""; // Si no hay origen, solo poner valor si ya existía
        }
        
        select.addEventListener("change", actualizarDatoFila);
        td.appendChild(select);
    }
    
    function actualizarDatoFila(event) { // Unificada para inputs y selects
        const element = event.target;
        const field = element.dataset.field;
        const index = parseInt(element.closest("tr").dataset.index, 10);
        let value = element.value.trim();

        if (element.getAttribute('inputmode') === 'decimal' && field !== 'API') {
             value = value.replace(/\./g, '').replace(',', '.');
        }
        if (currentData && currentData[index] !== undefined) {
            currentData[index][field] = value;
        }
    }
    
    function crearTdBotonEliminar(tr, index) {
        // ... (sin cambios, pero asegúrate que 'button.disabled = !edicionTransitoPermitida;' esté aquí)
        const td = document.createElement("td");
        td.classList.add("text-center");
        const button = document.createElement("button");
        button.className = "btn btn-danger btn-sm";
        button.innerHTML = '<i class="bi bi-trash"></i>';
        button.type = "button";
        button.disabled = !edicionTransitoPermitida; // Aplicar restricción
        button.onclick = function() {
            if (!edicionTransitoPermitida) return;
            if (currentData.length > 1) { 
                currentData.splice(index, 1);
                renderTabla(); 
            } else {
                mostrarAlerta("Debe haber al menos una fila.", "warning");
            }
        };
        td.appendChild(button);
        tr.appendChild(td);
    }
    
    function agregarFilaTransito() {
        if (!edicionTransitoPermitida) {
            mostrarAlerta("No se pueden añadir filas. Los registros están cerrados.", "warning");
            return;
        }
        const nuevaFilaVacia = {"ORIGEN": "", "FECHA": "", "GUIA": "", "PRODUCTO": "", "PLACA": "", "API": "", "BSW": "", "TOV": "", "GSV": "", "NSV": ""};
        currentData.push(nuevaFilaVacia);
        
        const newIndex = currentData.length - 1;
        const tr = document.createElement("tr");
        tr.dataset.index = newIndex;

        crearTdFecha(tr, nuevaFilaVacia, "FECHA");
        crearTdInputAlfanumerico(tr, nuevaFilaVacia, "GUIA");
        crearTdOrigen(tr, nuevaFilaVacia, "ORIGEN"); 
        crearTdProducto(tr, nuevaFilaVacia, "PRODUCTO"); 
        crearTdInputAlfanumerico(tr, nuevaFilaVacia, "PLACA");
        ['API', 'BSW', 'TOV', 'GSV', 'NSV'].forEach(campoKey => {
            crearTdInputNumerico(tr, nuevaFilaVacia, campoKey);
        });
        crearTdBotonEliminar(tr, newIndex);
        tablaTransitoBody.appendChild(tr);
        
        const primerInputCampo = tr.querySelector('select[data-field="ORIGEN"]');
        if (primerInputCampo) primerInputCampo.focus();
        tr.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    function cambiarVista() {
        vistaActual = vistaActual === "general" ? "refineria" : "general";
        tipoTransitoVisualSpan.textContent = vistaActual === "general" ? "Tránsito Crudo EDSM" : "Tránsito Crudo Refinería";
        toggleNombreVistaSpan.textContent = vistaActual === "general" ? "Tránsito Crudo Refinería" : "Tránsito Crudo EDSM";
        renderTabla(); // Esto ya manejará la restricción de edición si aplica
    }

    function mostrarAlerta(mensaje, tipo = 'info', duracion = 4000) {
        const alertContainer = document.getElementById('alert-container');
        if (!alertContainer) { console.error("Contenedor de alertas no encontrado."); return; }
        const wrapper = document.createElement('div');
        let iconClass = 'bi-info-circle-fill';
        if (tipo === 'success') iconClass = 'bi-check-circle-fill';
        if (tipo === 'danger') iconClass = 'bi-exclamation-triangle-fill';
        if (tipo === 'warning') iconClass = 'bi-exclamation-diamond-fill';
        wrapper.innerHTML = `<div class="alert alert-${tipo} alert-dismissible fade show d-flex align-items-center" role="alert"><i class="bi ${iconClass} me-2"></i><div>${mensaje}</div><button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>`;
        alertContainer.appendChild(wrapper);
        const alertElement = wrapper.firstChild;
        if (alertElement) { setTimeout(() => { const alertInstance = bootstrap.Alert.getOrCreateInstance(alertElement); if (alertInstance) { alertInstance.close(); } else if (wrapper.parentElement) { wrapper.remove(); } }, duracion); }
    }

    function guardarRegistro() {
        if (!edicionTransitoPermitida) {
            mostrarAlerta("❌ Los registros están cerrados después de las " + HORA_LIMITE_REGISTRO_TRANSITO + ":00 AM.", "warning");
            return;
        }
        const datosAEnviar = currentData.filter(fila => 
            Object.values(fila).some(valor => valor !== null && String(valor).trim() !== "") // Enviar solo si alguna celda tiene valor
        );

        if (datosAEnviar.length === 0) {
            mostrarAlerta("⚠️ No hay datos para guardar. Todas las filas están vacías.", "warning");
            return;
        }
        // Validar que en las filas a enviar, si hay un ORIGEN, también haya un PRODUCTO
        for (const fila of datosAEnviar) {
            if (fila.ORIGEN && !fila.PRODUCTO) {
                mostrarAlerta(`❌ Error: La fila con Guía '${fila.GUIA || '(vacía)'}' tiene un Origen seleccionado pero no un Producto.`, "danger", 6000);
                return;
            }
        }

        mostrarAlerta("Guardando registro, por favor espera...", "info", 6000);
        fetch(`/guardar-registro-transito-${vistaActual}`, {
            method: "POST",
            headers: { "Content-Type": "application/json", "X-Requested-With": "XMLHttpRequest" },
            body: JSON.stringify(datosAEnviar)
        })
        .then(res => { 
            if (res.status === 401) { return res.json().then(errData => { let err = new Error(errData.message || "Sesión expirada."); err.isAuthenticationError = true; throw err; }); }
            if (!res.ok) { return res.json().catch(() => { throw new Error(`Error del servidor: ${res.status} ${res.statusText}. Respuesta no fue JSON.`); }).then(parsedError => { throw new Error(parsedError.message || `Error ${res.status} del servidor.`); });}
            return res.json();
        })
        .then(data => {
            if (data.success) { mostrarAlerta("✅ Registro guardado exitosamente!", "success"); }
            else { mostrarAlerta("❌ Error al guardar: " + (data.message || "El servidor indicó un fallo."), "danger");}
        })
        .catch(error => {
             console.error("Error en fetch /guardar-registro-transito-:", error);
            if (error.isAuthenticationError) { mostrarAlerta("⚠️ " + error.message + " Redirigiendo al login...", "warning", 5000); setTimeout(() => { window.location.href = "{{ url_for('login') }}?next=" + encodeURIComponent(window.location.pathname + window.location.search); }, 3000);
            } else { mostrarAlerta("❌ Error: " + error.message, "danger", 8000); }
        });
    }

    document.addEventListener("DOMContentLoaded", () => {
        const ahora = new Date();
        const horaActual = ahora.getHours();

        if (horaActual >= HORA_LIMITE_REGISTRO_TRANSITO) {
            edicionTransitoPermitida = false;
            if (btnGuardarTransito) {
                btnGuardarTransito.disabled = true;
                btnGuardarTransito.classList.remove('btn-success');
                btnGuardarTransito.classList.add('btn-secondary');
            }
            if (btnAnadirFilaTransito) btnAnadirFilaTransito.disabled = true;
            // if (btnCambiarVistaTransito) btnCambiarVistaTransito.disabled = true; // Opcional

            const avisoDiv = document.createElement('div');
            avisoDiv.innerHTML = `
                <div class="alert alert-warning text-center aviso-hora-limite" role="alert">
                    <i class="bi bi-clock-fill me-2"></i>Los registros para Tránsito hoy se aceptan únicamente antes de las ${HORA_LIMITE_REGISTRO_TRANSITO}:00 AM. La planilla está bloqueada.
                </div>
            `;
            const actionButtonsBar = document.querySelector('.action-buttons-bar');
            if (actionButtonsBar && actionButtonsBar.parentNode) {
                actionButtonsBar.parentNode.insertBefore(avisoDiv, actionButtonsBar.nextSibling);
            }
        }
        tipoTransitoVisualSpan.textContent = vistaActual === "general" ? "Tránsito Crudo EDSM" : "Tránsito Crudo Refinería";
        toggleNombreVistaSpan.textContent = vistaActual === "general" ? "Tránsito Crudo Refinería" : "Tránsito Crudo EDSM";
        renderTabla(); 
    });
</script>
{% endblock %}